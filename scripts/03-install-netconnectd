set -x
set -e

export LC_ALL=C

source /common.sh
install_cleanup_trap

echo "Installing hostapd dnsmasq logrotate rfkill python3-pip..."
apt install --yes hostapd dnsmasq logrotate rfkill python3-pip
echo "Disabling default hostapd and dnsmasq services post install..."
update-rc.d -f hostapd remove
update-rc.d -f dnsmasq remove 
echo "Adding 60 second timeout to dhclient.conf..."
bash -c 'cat > /etc/dhcp/dhclient.conf' << EOF
timeout 60;
EOF
echo "Installing netconnectd..."
cd /home/pi/
git clone https://github.com/mrbeam/netconnectd_mrbeam
cd netconnectd_mrbeam
python3 setup.py install
python3 setup.py install_extras
update-rc.d netconnectd defaults 98
echo "Installing OctoPrint-Netconnectd plugin..."
sudo -u pi /home/pi/oprint/bin/pip install https://github.com/mrbeam/OctoPrint-Netconnectd/archive/refs/heads/develop.zip
